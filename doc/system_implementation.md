# 系统实现文档 (System Implementation Documentation)

本文档详细说明了游戏内收集、采集和对话系统的实现细节，以及与《星露谷物语》原版机制的对应关系。

## 1. 收集系统 (Collection System)

### 实现细节
- **物品吸附**: 实现了磁力吸附逻辑。当掉落物（DroppedItem）距离玩家一定范围内（默认 3.5 格）时，会触发向玩家移动的动画。当距离小于 1.5 格时，自动尝试拾取。
- **背包管理**: 
  - 实现了 36 格背包限制。
  - 实现了物品堆叠机制，最大堆叠数量为 999。
  - `addToInventory` 函数负责处理堆叠逻辑：优先填充已存在的相同物品堆叠，溢出部分或新物品尝试放入空闲格子。如果背包已满且无法堆叠，则拾取失败。
- **视觉反馈**: 物品拾取成功后，会在玩家头顶显示 "+数量 物品名" 的浮动文字，颜色根据物品类型区分（资源类为棕色，作物类为橙色）。

### 与原版对比
- **一致性**: 磁力范围、背包格数（36）、堆叠上限（999）均与原版一致。
- **改进**: 当前版本实现了基础磁力，未来可扩展戒指（磁铁戒指）对磁力范围的加成。

## 2. 采集系统 (Gathering System)

### 实现细节
- **工具交互**: 
  - `handlePlotInteraction` 统一管理工具与地块的交互。
  - **锄头 (Hoe)**: 耕地，消耗体力，增加锄头熟练度。
  - **镐子 (Pickaxe)**: 破坏石头，破坏耕地，消耗体力，增加采矿熟练度。
  - **斧头 (Axe)**: 砍伐树枝/木头，清除杂草，消耗体力，增加采集熟练度。
  - **喷壶 (Watering Can)**: 浇灌作物，消耗体力，增加耕种熟练度。
  - **镰刀 (Scythe)**: 清除杂草，**不消耗体力**，收割特定作物。
- **体力与熟练度**:
  - 实现了 `toolProficiency`（工具熟练度）系统，包含 hoe, pickaxe, axe, watering, fishing。
  - 体力消耗通过 `calculateStaminaCost` 动态计算。基础消耗为 2 点。
  - 随着熟练度提升（0-10级），体力消耗逐渐降低（每级降低 0.1，最低 0.1）。
- **资源再生**:
  - `processNewDay` 中调用 `spawnDailyResources`。
  - 每天早上有 1% 的概率在农场的空闲草地上生成杂草、树枝或石头，模拟原版的杂物蔓延机制。

### 与原版对比
- **一致性**: 工具功能、体力消耗基准、熟练度影响均参考原版设计。
- **细节**: 原版镰刀割草不耗体力，本项目已复现此逻辑。

## 3. 对话系统 (Dialogue System)

### 实现细节
- **NPC 数据结构**: 扩展了 `NPC` 接口，增加了 `relationship` (好感度) 和 `talkedToday` (今日是否对话) 字段。
- **交互逻辑**:
  - `interactWithNPC` 处理与 NPC 的交互。
  - **每日首次对话**: 增加 20 点好感度，并在头顶显示爱心特效。
  - **重复对话**: 循环播放 NPC 的对话列表，不再增加好感度。
  - **每日重置**: `processNewDay` 会重置所有 NPC 的 `talkedToday` 状态。
- **日程系统**: 基础的 `updateNPCSchedules` 已存在，支持 NPC 根据时间移动位置。

### 与原版对比
- **一致性**: 每日对话 +20 好感度、爱心反馈、对话循环机制与原版一致。
- **扩展性**: 数据结构已预留 `friendshipPoints` 和 `schedule`，支持未来扩展更复杂的日程和事件触发。

## 4. 特殊事件与音效 (Special Events & Sound)

### 音效系统
- **SoundManager**: 实现了单例模式的音效管理器，支持预加载和播放。
- **触发**: 在采集（挥动工具）、收集（拾取物品）、对话（打开对话框）时触发相应音效。
- **优雅降级**: 若无音频文件，控制台会输出模拟日志，不影响游戏流程。

### 事件系统
- **GameEvent**: 定义了事件结构，包含触发条件（季节、日期、NPC好感度、地点）和执行动作。
- **复活节 (Egg Festival)**: 实现了春季 13 日的节日提醒事件。
- **爱心事件 (Heart Events)**: 实现了基于 NPC 好感度（如 2 心）和地点的触发逻辑。
- **检测机制**: 在 `processNewDay` (每日开始) 和 `interactWithNPC` (交互时) 进行事件检测。

## 5. 测试与验证

### 单元测试
项目包含 `src/stores/game.test.ts`，使用 Vitest 框架对核心逻辑进行了覆盖测试：
1. **收集测试**: 验证了背包满载、堆叠逻辑的正确性。
2. **采集测试**: 验证了不同熟练度下的体力消耗计算，以及镰刀零消耗逻辑。
3. **对话测试**: 验证了每日首次对话加分及次日重置逻辑。

### 运行测试
使用 `npm test` (或 `npx vitest run`) 即可运行所有测试用例。
